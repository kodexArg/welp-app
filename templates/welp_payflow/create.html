{% extends "core/base.html" %}
{% load core_tags %}

{% block title %}Crear Solicitud - Welp Payflow{% endblock %}

{% block content %}
<style>
.form-component {
    opacity: 0.1;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
}

.form-component.active {
    opacity: 1;
    pointer-events: auto;
}

.button-primary:disabled,
.button-secondary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    transition: none !important;
}

.button-primary:disabled:hover,
.button-secondary:disabled:hover {
    transform: none !important;
    filter: none !important;
}
</style>

<section>
    <h2>Crear Nueva Solicitud</h2>
    
    <form method="post" enctype="multipart/form-data" id="payflow-form">
        {% csrf_token %}
        
        <div id="component-udn" class="form-component">
            {% select_field form.udn %}
        </div>
        
        <div id="component-sector" class="form-component">
            {% select_field form.sector %}
        </div>
        
        <div id="component-accounting" class="form-component">
            {% select_field form.accounting_category %}
        </div>
        
        <div id="component-fields-body" class="form-component">
            {% select_fields_body form %}
        </div>
        
        {% if form.non_field_errors %}
            <article>
                <div class="text-status-open">
                    {{ form.non_field_errors }}
                </div>
            </article>
        {% endif %}
        
        <div id="component-buttons" class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{% url 'welp_payflow:index' %}" class="button-secondary">
                Volver
            </a>
            <button type="button" class="button-secondary" id="clear-button">
                Limpiar
            </button>
            <button type="submit" form="payflow-form" class="button-primary" id="submit-button" disabled>
                Crear Solicitud
            </button>
        </div>
    </form>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const components = ['component-udn', 'component-sector', 'component-accounting', 'component-fields-body'];
    const fields = {
        udn: document.querySelector('select[name="udn"]'),
        sector: document.querySelector('select[name="sector"]'),
        accounting_category: document.querySelector('select[name="accounting_category"]'),
        title: document.querySelector('input[name="title"]'),
        description: document.querySelector('textarea[name="description"]'),
        estimated_amount: document.querySelector('input[name="estimated_amount"]')
    };
    
    function toggleComponent(componentId, enable) {
        const component = document.getElementById(componentId);
        if (!component) return;
        
        component.classList.toggle('active', enable);
        component.querySelectorAll('input, textarea, select').forEach(input => {
            input.disabled = !enable;
        });
    }
    
    async function loadSelectOptions(fieldType, params = {}) {
        try {
            const url = new URL(`{% url 'welp_payflow:select-options' 'FIELD_TYPE' %}`.replace('FIELD_TYPE', fieldType), window.location.origin);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                console.error('Error loading options:', data.error);
                return [];
            }
            
            return data.options || [];
        } catch (error) {
            console.error('Error fetching options:', error);
            return [];
        }
    }
    
    function updateSelectField(field, options) {
        if (!field) return;
        
        field.innerHTML = '';
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            field.appendChild(optionElement);
        });
    }
    
    async function handleUdnChange() {
        const udnValue = fields.udn?.value;
        
        if (udnValue) {
            const sectorOptions = await loadSelectOptions('sector', { udn_id: udnValue });
            updateSelectField(fields.sector, sectorOptions);
        } else {
            updateSelectField(fields.sector, [{ value: '', text: '--- Seleccionar Sector ---' }]);
        }
        
        fields.sector.value = '';
        fields.accounting_category.value = '';
        
        evaluateComponents();
    }
    
    async function handleSectorChange() {
        evaluateComponents();
    }
    
    function evaluateComponents() {
        let activeIndex = -1;
        
        if (fields.udn?.value) {
            activeIndex = 0;
            if (fields.sector?.value) {
                activeIndex = 1;
                if (fields.accounting_category?.value) {
                    activeIndex = 2;
                }
            }
        }
        
        components.forEach((id, index) => {
            toggleComponent(id, index <= activeIndex + 1);
        });
    }
    
    function checkSubmitButton() {
        const required = [fields.title?.value.trim(), fields.description?.value.trim(), fields.estimated_amount?.value];
        document.getElementById('submit-button').disabled = !required.every(Boolean);
    }
    
    async function clearForm() {
        Object.values(fields).forEach(field => {
            if (!field) return;
            field.value = field.tagName === 'SELECT' ? (field.selectedIndex = 0, '') : '';
        });
        
        await loadInitialOptions();
        
        components.forEach(id => toggleComponent(id, false));
        toggleComponent(components[0], true);
        checkSubmitButton();
    }
    
    async function loadInitialOptions() {
        const udnOptions = await loadSelectOptions('udn');
        updateSelectField(fields.udn, udnOptions);
        
        updateSelectField(fields.sector, [{ value: '', text: '--- Seleccionar Sector ---' }]);
        
        const accountingOptions = await loadSelectOptions('accounting');
        updateSelectField(fields.accounting_category, accountingOptions);
    }
    
    async function initializeForm() {
        await loadInitialOptions();
        
        components.forEach(id => toggleComponent(id, false));
        toggleComponent(components[0], true);
        
        fields.udn?.addEventListener('change', handleUdnChange);
        fields.sector?.addEventListener('change', handleSectorChange);
        fields.accounting_category?.addEventListener('change', evaluateComponents);
        
        ['title', 'description', 'estimated_amount'].forEach(name => {
            fields[name]?.addEventListener('input', checkSubmitButton);
        });
        
        document.getElementById('clear-button')?.addEventListener('click', clearForm);
        
        evaluateComponents();
        checkSubmitButton();
    }
    
    initializeForm();
});
</script>
{% endblock %} 