{% extends "core/base.html" %}
{% load core_tags %}

{% block title %}Crear Solicitud - Welp Payflow{% endblock %}

{% block content %}
<style>
.form-component {
    opacity: 0.1;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
}

.form-component.active {
    opacity: 1 !important;
    pointer-events: auto !important;
}

.form-component.active .select-field {
    opacity: 1 !important;
    pointer-events: auto !important;
}

.button-primary:disabled,
.button-secondary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    transition: none !important;
}

.button-primary:disabled:hover,
.button-secondary:disabled:hover {
    transform: none !important;
    filter: none !important;
}
</style>

<section>
    <h2>Crear Nueva Solicitud</h2>
    
    <form method="post" enctype="multipart/form-data" id="payflow-form">
        {% csrf_token %}
        
        <div id="component-udn" class="form-component">
            {% select_field form.udn %}
        </div>
        
        <div id="component-sector" class="form-component">
            {% select_field form.sector %}
        </div>
        
        <div id="component-accounting" class="form-component">
            {% select_field form.accounting_category %}
        </div>
        
        <div id="component-fields-body" class="form-component">
            {% select_fields_body form %}
        </div>
        
        {% if form.non_field_errors %}
            <article>
                <div class="text-status-open">
                    {{ form.non_field_errors }}
                </div>
            </article>
        {% endif %}
        
        <div id="component-buttons" class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{% url 'welp_payflow:index' %}" class="button-secondary">
                Volver
            </a>
            <button type="button" class="button-secondary" id="clear-button">
                Limpiar
            </button>
            <button type="submit" form="payflow-form" class="button-primary" id="submit-button" disabled>
                Crear Solicitud
            </button>
        </div>
    </form>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const components = ['component-udn', 'component-sector', 'component-accounting', 'component-fields-body'];
    const fields = {
        udn: document.querySelector('input[name="udn"]'),
        sector: document.querySelector('input[name="sector"]'),
        accounting_category: document.querySelector('input[name="accounting_category"]'),
        title: document.querySelector('input[name="title"]'),
        description: document.querySelector('textarea[name="description"]'),
        estimated_amount: document.querySelector('input[name="estimated_amount"]')
    };
    
    /**
     * Gets field value (supports both traditional fields and treemap components)
     */
    function getFieldValue(fieldName) {
        const field = fields[fieldName];
        if (!field) return '';
        
        const treemapApi = window[`selectField_${fieldName}`];
        if (treemapApi) {
            return treemapApi.getCurrentValue();
        }
        
        return field.value || '';
    }
    
    /**
     * Sets field value (supports both traditional fields and treemap components)
     */
    function setFieldValue(fieldName, value) {
        const field = fields[fieldName];
        if (!field) return;
        
        const treemapApi = window[`selectField_${fieldName}`];
        if (treemapApi) {
            treemapApi.selectValue(value);
        } else {
            field.value = value;
        }
    }
    
    /**
     * Toggles component visibility and enables/disables its form controls
     */
    function toggleComponent(componentId, enable) {
        const component = document.getElementById(componentId);
        if (!component) return;
        
        component.classList.toggle('active', enable);
        component.querySelectorAll('input, textarea, select').forEach(input => {
            input.disabled = !enable;
        });
        
        // Handle treemap components
        const fieldName = componentId.replace('component-', '');
        const treemapApi = window[`selectField_${fieldName}`];
        if (treemapApi) {
            treemapApi.setEnabled(enable);
        }
    }
    
    /**
     * Fetches select field options from the API with optional parameters
     */
    async function loadSelectOptions(fieldType, params = {}) {
        try {
            const url = new URL(`{% url 'welp_payflow:select-options' 'FIELD_TYPE' %}`.replace('FIELD_TYPE', fieldType), window.location.origin);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                console.error('Error loading options:', data.error);
                return [];
            }
            
            return data.options || [];
        } catch (error) {
            console.error('Error fetching options:', error);
            return [];
        }
    }
    
    /**
     * Updates a select field with new option elements (supports both select and treemap)
     */
    function updateSelectField(field, options) {
        if (!field) return;
        
        const fieldName = field.name;
        const treemapApi = window[`selectField_${fieldName}`];
        
        if (treemapApi) {
            // Use treemap component API
            treemapApi.updateOptions(options);
        } else {
            // Fallback to traditional select
            field.innerHTML = '';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                field.appendChild(optionElement);
            });
        }
    }
    
    /**
     * Handles UDN field changes and updates dependent sector options
     */
    async function handleUdnChange() {
        const udnValue = getFieldValue('udn');
        
        if (udnValue) {
            const sectorOptions = await loadSelectOptions('sector', { udn_id: udnValue });
            updateSelectField(fields.sector, sectorOptions);
        } else {
            updateSelectField(fields.sector, [{ value: '', text: '--- Seleccionar Sector ---' }]);
        }
        
        setFieldValue('sector', '');
        setFieldValue('accounting_category', '');
        
        evaluateComponents();
    }
    
    /**
     * Handles sector field changes and triggers component evaluation
     */
    async function handleSectorChange() {
        evaluateComponents();
    }
    
    /**
     * Evaluates which form components should be active based on field values
     */
    function evaluateComponents() {
        let activeIndex = -1;
        
        if (getFieldValue('udn')) {
            activeIndex = 0;
            if (getFieldValue('sector')) {
                activeIndex = 1;
                if (getFieldValue('accounting_category')) {
                    activeIndex = 2;
                }
            }
        }
        
        components.forEach((id, index) => {
            toggleComponent(id, index <= activeIndex + 1);
        });
    }
    
    /**
     * Checks if all required fields are filled and enables/disables submit button
     */
    function checkSubmitButton() {
        const required = [fields.title?.value.trim(), fields.description?.value.trim(), fields.estimated_amount?.value];
        document.getElementById('submit-button').disabled = !required.every(Boolean);
    }
    
    /**
     * Clears all form fields and resets to initial state
     */
    async function clearForm() {
        // Clear all fields using the unified approach
        Object.keys(fields).forEach(fieldName => {
            const field = fields[fieldName];
            if (!field) return;
            
            // Use setFieldValue for select fields (udn, sector, accounting_category)
            if (['udn', 'sector', 'accounting_category'].includes(fieldName)) {
                setFieldValue(fieldName, '');
            } else {
                // Traditional fields (title, description, estimated_amount)
                field.value = '';
            }
        });
        
        await loadInitialOptions();
        
        components.forEach(id => toggleComponent(id, false));
        toggleComponent(components[0], true);
        checkSubmitButton();
    }
    
    /**
     * Loads initial options for all select fields from the API
     */
    async function loadInitialOptions() {
        // Show loading states for treemap components
        ['udn', 'sector', 'accounting_category'].forEach(fieldName => {
            const treemapApi = window[`selectField_${fieldName}`];
            if (treemapApi) {
                treemapApi.showLoading();
            }
        });
        
        try {
            const udnOptions = await loadSelectOptions('udn');
            updateSelectField(fields.udn, udnOptions);
            
            updateSelectField(fields.sector, [{ value: '', text: '--- Seleccionar Sector ---' }]);
            
            const accountingOptions = await loadSelectOptions('accounting');
            updateSelectField(fields.accounting_category, accountingOptions);
        } catch (error) {
            console.error('Error loading initial options:', error);
        }
    }
    
    /**
     * Waits for treemap components to be ready
     */
    function waitForTreemapComponents() {
        return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 100; // 5 seconds max
            
            const checkInterval = setInterval(() => {
                attempts++;
                const treemapApis = ['udn', 'sector', 'accounting_category'].map(name => 
                    window[`selectField_${name}`]
                );
                
                console.log(`Attempt ${attempts}: Checking treemap APIs`, treemapApis.map(api => api !== undefined));
                
                if (treemapApis.every(api => api !== undefined)) {
                    console.log('All treemap APIs ready!');
                    clearInterval(checkInterval);
                    resolve();
                } else if (attempts >= maxAttempts) {
                    console.warn('Timeout waiting for treemap components, proceeding anyway');
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 50);
        });
    }
    
    /**
     * Initializes the form with options, event listeners, and initial state
     */
    async function initializeForm() {
        console.log('Starting form initialization...');
        
        // Wait for treemap components to be ready
        await waitForTreemapComponents();
        
        console.log('Loading initial options...');
        await loadInitialOptions();
        
        console.log('Setting up component states...');
        // Disable all components first
        components.forEach(id => toggleComponent(id, false));
        
        // Force enable the first component (UDN)
        console.log('Activating UDN component...');
        toggleComponent(components[0], true);
        
        // Double-check UDN component activation
        const udnComponent = document.getElementById('component-udn');
        if (udnComponent) {
            udnComponent.classList.add('active');
            console.log('UDN component class added manually');
        }
        
        // Ensure treemap is enabled too
        const udnTreemapApi = window[`selectField_udn`];
        if (udnTreemapApi) {
            udnTreemapApi.setEnabled(true);
            console.log('UDN treemap enabled via API');
        }
        
        console.log('Setting up event listeners...');
        fields.udn?.addEventListener('change', handleUdnChange);
        fields.sector?.addEventListener('change', handleSectorChange);
        fields.accounting_category?.addEventListener('change', evaluateComponents);
        
        ['title', 'description', 'estimated_amount'].forEach(name => {
            fields[name]?.addEventListener('input', checkSubmitButton);
        });
        
        document.getElementById('clear-button')?.addEventListener('click', clearForm);
        
        console.log('Final evaluation...');
        evaluateComponents();
        checkSubmitButton();
        
        console.log('Form initialization complete!');
    }
    
    initializeForm();
});
</script>
{% endblock %} 