{% extends "core/base.html" %}
{% load core_tags %}

{% block title %}Crear Solicitud - Welp Payflow{% endblock %}

{% block content %}
<style>
.form-component {
    opacity: 0.1;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
}

.form-component.active {
    opacity: 1;
    pointer-events: auto;
}

.button-primary:disabled,
.button-secondary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    transition: none !important;
}

.button-primary:disabled:hover,
.button-secondary:disabled:hover {
    transform: none !important;
    filter: none !important;
}
</style>

<section>
    <h2>Crear Nueva Solicitud</h2>
    
    <form method="post" enctype="multipart/form-data" id="payflow-form">
        {% csrf_token %}
        
        <div id="component-udn" class="form-component">
            {% select_field form.udn %}
        </div>
        
        <div id="component-sector" class="form-component">
            {% select_field form.sector %}
        </div>
        
        <div id="component-accounting" class="form-component">
            {% select_field form.accounting_category %}
        </div>
        
        <div id="component-fields-body" class="form-component">
            {% select_fields_body form %}
        </div>
        
        {% if form.non_field_errors %}
            <article>
                <div class="text-status-open">
                    {{ form.non_field_errors }}
                </div>
            </article>
        {% endif %}
        
        <div id="component-buttons" class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{% url 'welp_payflow:index' %}" class="button-secondary">
                Volver
            </a>
            <button type="button" class="button-secondary" id="clear-button">
                Limpiar
            </button>
            <button type="submit" form="payflow-form" class="button-primary" id="submit-button" disabled>
                Crear Solicitud
            </button>
        </div>
    </form>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const components = ['component-udn', 'component-sector', 'component-accounting', 'component-fields-body'];
    const fields = {
        udn: document.querySelector('select[name="udn"]'),
        sector: document.querySelector('select[name="sector"]'),
        accounting_category: document.querySelector('select[name="accounting_category"]'),
        title: document.querySelector('input[name="title"]'),
        description: document.querySelector('textarea[name="description"]'),
        estimated_amount: document.querySelector('input[name="estimated_amount"]')
    };
    
    function toggleComponent(componentId, enable) {
        const component = document.getElementById(componentId);
        if (!component) return;
        
        component.classList.toggle('active', enable);
        component.querySelectorAll('input, textarea, select').forEach(input => {
            input.disabled = !enable;
        });
    }
    
    function evaluateComponents() {
        let activeIndex = -1;
        
        if (fields.udn?.value) {
            activeIndex = 0;
            if (fields.sector?.value) {
                activeIndex = 1;
                if (fields.accounting_category?.value) {
                    activeIndex = 2;
                }
            }
        }
        
        components.forEach((id, index) => {
            toggleComponent(id, index <= activeIndex + 1);
        });
    }
    
    function checkSubmitButton() {
        const required = [fields.title?.value.trim(), fields.description?.value.trim(), fields.estimated_amount?.value];
        document.getElementById('submit-button').disabled = !required.every(Boolean);
    }
    
    function clearForm() {
        Object.values(fields).forEach(field => {
            if (!field) return;
            field.value = field.tagName === 'SELECT' ? (field.selectedIndex = 0, '') : '';
        });
        components.forEach(id => toggleComponent(id, false));
        toggleComponent(components[0], true);
        checkSubmitButton();
    }
    
    components.forEach(id => toggleComponent(id, false));
    toggleComponent(components[0], true);
    
    ['udn', 'sector', 'accounting_category'].forEach(name => {
        fields[name]?.addEventListener('change', evaluateComponents);
    });
    
    ['title', 'description', 'estimated_amount'].forEach(name => {
        fields[name]?.addEventListener('input', checkSubmitButton);
    });
    
    document.getElementById('clear-button')?.addEventListener('click', clearForm);
    
    evaluateComponents();
    checkSubmitButton();
});
</script>
{% endblock %} 