{% extends "core/base.html" %}
{% load core_tags %}
{% load django_vite %}

{% block title %}{{ ticket.title }} - Welp Payflow{% endblock %}

{% block content %}
<section class="max-w-3xl mx-auto">
    <div class="ticket-detail-header flex justify-between items-center w-full mb-8">
        <a href="{% url 'welp_payflow:list' %}" class="button-primary flex items-center gap-2 shadow-md">
            <i class="fa fa-arrow-left"></i>
            <span>Solicitudes</span>
        </a>
        <div class="flex flex-col md:flex-row md:items-center md:justify-end md:gap-6 w-full">
            {% with status_info=ticket|get_status_flow %}
            {% if ticket.status != 'closed' %}
            <span class="order-2 md:order-1 ticket-action-closed">
                <i class="ticket-action-icon-closed"></i>
                {{ status_info.current_action }}
            </span>
            {% endif %}
            {% endwith %}
            <div class="order-1 md:order-2 flex flex-col items-end">
                {% ticket_status ticket %}
                {% if ticket.status_note %}
                    <div class="text-right mt-1">
                        <span class="text-sm text-forest-700 font-semibold">{{ ticket.status_note }}</span><br>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if response_type == 'close' %}
        <div class="ticket-detail-container">
            {% ticket_container ticket expandido=True hide_buttons=True %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
                {% if is_owner %}
                    <p class="text-yellow-700">Está cerrando su propio ticket.</p>
                {% else %}
                    <p class="text-yellow-700">Está cerrando un ticket creado por otro usuario.</p>
                {% endif %}
            </div>
        </div>
        {% ticket_message_input form_action=process_close_url button_text="Confirmar Cierre" label_text="Comentario" placeholder="Explique el motivo del cierre" cancel_url=cancel_url required=requires_comment field_name="close_comment" %}
    {% elif response_type == 'authorize' %}
        <div class="ticket-detail-container">
            {% ticket_container ticket expandido=True hide_buttons=True %}
            <div class="bg-sky-50 border-l-4 border-sky-400 p-4 mb-6 rounded-r-lg">
                <p class="text-sky-700">Confirme si desea autorizar este ticket.</p>
            </div>
        </div>
        {% ticket_message_input form_action=authorize_url button_text="Autorizar" label_text="Comentario" placeholder="Comentario de autorización (opcional)" cancel_url=cancel_url required=False field_name="authorize_comment" %}
    {% else %}
        <div class="ticket-detail-container">
            {% ticket_container ticket expandido=True hide_buttons=True %}
        </div>
        {% ticket_message_input form_action=request.get_full_path show_attachments=True cancel_url="welp_payflow:list" %}
    {% endif %}
</section>

{% endblock %}

{% block scripts %}
    {% vite_asset 'frontend/js/welp_payflow/attachment_manager.js' %}
{% endblock %}