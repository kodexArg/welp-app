{% extends "core/base.html" %}
{% load i18n %}
{% load django_vite %}

{% block title %}Manual de Usuario: Workflow de Compras - Herramientas de Desarrollo{% endblock %}

{% block content %}
<section class="my-6 max-w-4xl mx-auto">
    <article class="mb-12 bg-transparent border-none shadow-none">
        <div class="text-center mb-12">
            <h1 class="text-3xl text-text">Manual de Usuario: Workflow de Compras</h1>
            <p class="text-lg text-primary/80 font-[var(--font-body)] mt-2">Guía completa del proceso de solicitudes de compra y pago en Welp Payflow.</p>
        </div>
        <!-- Flujo Simplificado Visual -->
        <div class="mb-12">
            <h2 class="text-xl font-medium text-center mb-6 text-primary font-title">Flujo Simplificado de Estados</h2>
            <div class="flex justify-center mb-8">
                {% include "core/dev/partials/workflow_graph.html" %}
            </div>
        </div>
    </article>

    <article class="mb-12">
        <!-- Roles -->
        <div class="mb-12">
            <h2 class="text-xl font-medium text-center mb-6 text-primary font-title">Actores del Proceso (Roles)</h2>
            <div class="space-y-4">
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">1. Usuario Final</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Crea solicitudes para sí mismo, añade comentarios y confirma la recepción para cerrar el ticket.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">2. Técnico</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Además de crear tickets, puede ver las solicitudes autorizadas de su área para buscar y adjuntar presupuestos.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">3. Supervisor de Área</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Realiza la <strong class="font-bold">primera autorización</strong> de las solicitudes de su equipo. Puede ver todos los tickets de su área y rechazarlos si es necesario.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">4. Gestor de Compras</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Gestiona las solicitudes autorizadas, adjunta presupuestos, procesa los pagos y coordina la entrega.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">5. Gerente / Director</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Tiene permisos de Supervisor y es el <strong class="font-bold">único que autoriza el pago final</strong> sobre un ticket ya presupuestado.</p>
                </div>
            </div>
        </div>
    </article>

    <article class="mb-12">
        <!-- Detalle de Estados y Transiciones -->
        <div class="mb-12">
            <h2 class="text-xl font-medium text-center mb-6 text-primary font-title">Detalle de Estados y Transiciones</h2>
            <div class="space-y-6">
                <!-- Open -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">🔴 Abierto</div><p class="text-sm text-primary/90">La solicitud ha sido creada y está esperando la aprobación inicial.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Siguiente paso:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Autorizar o Rechazar</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Supervisor, Gerente</span></div></div>
                <!-- Authorized -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">🟣 Autorizado</div><p class="text-sm text-primary/90">La solicitud fue aprobada. Ahora se deben buscar y adjuntar presupuestos.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Siguiente paso:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Adjuntar Presupuestos</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras, Técnico</span></div></div>
                <!-- Budgeted -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">🟢 Presupuestado</div><p class="text-sm text-primary/90">Se adjuntaron los presupuestos. Se necesita la aprobación final para el pago.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Siguiente paso:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Autorizar Pago o Rechazar</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gerente</span></div></div>
                 <!-- Rejected -->
                <div class="p-4 bg-yellow-50 border-yellow-300 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">🟡 Rechazado</div><p class="text-sm text-primary/90">La solicitud o los presupuestos fueron rechazados. Se necesita revisar y adjuntar nuevas opciones.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Siguiente paso:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Adjuntar Nuevos Presupuestos</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras, Técnico</span></div></div>
                <!-- Payment Authorized -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">🔶 Pago Autorizado</div><p class="text-sm text-primary/90">El Gerente aprobó el pago del presupuesto seleccionado.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Siguiente paso:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Procesar el Pago</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras</span></div></div>
                <!-- Processing Payment -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">💰 Procesando Pago</div><p class="text-sm text-primary/90">El Gestor de Compras está realizando los trámites para pagar al proveedor.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Siguiente paso:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Marcar como Enviado</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras</span></div></div>
                <!-- Shipping -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">📦 En Envío / Entrega</div><p class="text-sm text-primary/90">El producto o servicio ya ha sido pagado y está en camino.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Siguiente paso:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Confirmar Recepción y Cerrar</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Usuario, Gestor de Compras</span></div></div>
                <!-- Closed -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200"><div class="font-semibold text-text mb-2 font-ui">⚫ Cerrado</div><p class="text-sm text-primary/90">La solicitud se ha completado y finalizado.</p></div>
            </div>
        </div>
    </article>

    <article class="mb-12">
        <!-- Tabla de Transiciones -->
        <div class="mb-12">
            <h2 class="text-xl font-medium text-center mb-6 text-primary font-title">Tabla de Transiciones por Rol</h2>
            <div class="overflow-x-auto bg-white p-4 rounded-lg border border-border">
                <table class="min-w-full text-sm text-left">
                    <thead class="bg-surface font-ui text-text"><tr><th class="p-2">Desde el Estado</th><th class="p-2">Hacia el Estado</th><th class="p-2">¿Quién puede hacerlo?</th></tr></thead>
                    <tbody class="divide-y divide-border">
                        <tr class="hover:bg-surface/50"><td>Abierto</td><td>Autorizado</td><td>Supervisor, Gerente</td></tr>
                        <tr class="hover:bg-surface/50"><td>Abierto</td><td>Cerrado (Cancelar)</td><td>Supervisor, Gerente, Usuario creador</td></tr>
                        <tr class="hover:bg-surface/50"><td>Autorizado</td><td>Presupuestado</td><td>Gestor de Compras, Técnico</td></tr>
                        <tr class="hover:bg-surface/50"><td>Presupuestado</td><td>Pago Autorizado</td><td>Gerente</td></tr>
                        <tr class="hover:bg-surface/50"><td>Presupuestado</td><td>Rechazado</td><td>Supervisor, Gerente</td></tr>
                        <tr class="hover:bg-surface/50"><td>Rechazado</td><td>Presupuestado</td><td>Gestor de Compras, Técnico</td></tr>
                        <tr class="hover:bg-surface/50"><td>Pago Autorizado</td><td>Procesando Pago</td><td>Gestor de Compras</td></tr>
                        <tr class="hover:bg-surface/50"><td>Procesando Pago</td><td>En Envío / Entrega</td><td>Gestor de Compras</td></tr>
                        <tr class="hover:bg-surface/50"><td>En Envío / Entrega</td><td>Cerrado</td><td>Usuario creador, Gestor de Compras</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4"><p class="text-sm text-green-700 font-body"><strong class="font-semibold">Nota sobre Comentarios:</strong> Añadir un comentario a una solicitud **no cambia su estado**. Los comentarios son para añadir información, hacer preguntas o dar seguimiento.</p></div>
        </div>
    </article>

    <article class="mb-12">
        <!-- Ejemplo Práctico -->
        <div class="mb-12">
            <h2 class="text-xl font-medium text-center mb-6 text-primary font-title">Ejemplo Práctico: Compra de un Ordenador</h2>
            <ol class="relative border-l border-border ml-4">
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-user"></i></span><h3 class="font-semibold font-ui">1. Creación</h3><p class="text-sm text-primary/90 font-body">**Ana (Usuario Final)** crea una solicitud: "Necesito un nuevo ordenador para diseño". El ticket queda en estado **Abierto**.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-user-tie"></i></span><h3 class="font-semibold font-ui">2. Autorización Inicial</h3><p class="text-sm text-primary/90 font-body">**Carlos (Supervisor)** revisa la solicitud y la aprueba. El ticket cambia a **Autorizado**.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-file-invoice-dollar"></i></span><h3 class="font-semibold font-ui">3. Presupuesto</h3><p class="text-sm text-primary/90 font-body">**María (Gestor de Compras)** ve el ticket, busca tres presupuestos y los adjunta. El ticket cambia a **Presupuestado**.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-crown"></i></span><h3 class="font-semibold font-ui">4. Autorización Final</h3><p class="text-sm text-primary/90 font-body">**Luisa (Gerente)** revisa los presupuestos, elige uno y aprueba el pago. El ticket cambia a **Pago Autorizado**.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-credit-card"></i></span><h3 class="font-semibold font-ui">5. Gestión de Pago</h3><p class="text-sm text-primary/90 font-body">**María (Gestor de Compras)** realiza la compra y el pago. El ticket cambia a **Procesando Pago**.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-shipping-fast"></i></span><h3 class="font-semibold font-ui">6. Envío</h3><p class="text-sm text-primary/90 font-body">Una vez pagado, María actualiza el estado a **En Envío / Entrega**.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-check-circle"></i></span><h3 class="font-semibold font-ui">7. Cierre</h3><p class="text-sm text-primary/90 font-body">Cuando el ordenador llega, **Ana (Usuario Final)** confirma la recepción y el ticket se marca como **Cerrado**.</p></li>
            </ol>
        </div>
    </article>

</section>
{% endblock %}
{% block scripts %}
    {% vite_asset 'frontend/js/mermaid-init.js' %}
{% endblock %} 