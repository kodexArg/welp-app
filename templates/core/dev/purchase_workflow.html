{% extends "core/base.html" %}
{% load i18n %}
{% load django_vite %}

{% block title %}Manual T√©cnico: Workflow de Compras - Welp Payflow{% endblock %}

{% block content %}
<section class="my-6 max-w-4xl mx-auto">
    <h1 class="text-2xl text-text">An√°lisis del Workflow de Compras</h1>
    <div class="w-fit mx-auto px-18 py-1 bg-forest-600 rounded-t-2xl shadow-lg text-white text-2xl font-bold text-center">Flujo de Estados</div>
    <article class="mb-12 bg-forest-500 border-none shadow-none">
        <p class="text-center text-white mb-4">Diagrama de etapas y transiciones del flujo de compras.</p>
        <div class="w-full max-w-full overflow-x-auto my-8 bg-forest-300 rounded-lg p-12">
            <div class="w-full">{% include "core/dev/partials/workflow_graph.html" %}</div>
        </div>
    </article>

    <div class="w-fit mx-auto px-18 py-1 bg-forest-500 rounded-t-2xl shadow-lg text-white text-2xl font-bold text-center">Roles y Permisos</div>
    <article class="mb-12 bg-forest-400">
        <div class="space-y-4">
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">1. Usuario Final</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Crea solicitudes, a√±ade comentarios y confirma la recepci√≥n para cerrar tickets. Permiso clave: <strong>can_open</strong>.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">2. T√©cnico</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Crea tickets y, tras autorizaci√≥n, adjunta presupuestos. Permisos: <strong>can_open, can_comment, can_solve</strong>.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">3. Supervisor</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Realiza la primera autorizaci√≥n y puede cerrar o rechazar tickets de su √°rea. Permisos: <strong>can_open, can_comment, can_authorize, can_close</strong>.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">4. Gestor de Compras</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">Encargado del proceso de pago y env√≠o. Tambi√©n puede adjuntar presupuestos. Permisos: <strong>can_open, can_comment, can_solve, can_process_payment</strong>.</p>
                </div>
                <div class="p-4 bg-white border border-border rounded-lg">
                    <h3 class="font-semibold text-text font-ui">5. Manager</h3>
                    <p class="text-sm text-primary/90 font-body mt-1">√önico rol que autoriza el pago final. Posee permisos de Supervisor. Permisos: <strong>can_open, can_comment, can_authorize, can_process_payment, can_close</strong>.</p>
                </div>
            </div>
    </article>

    <div class="w-fit mx-auto px-18 py-1 bg-forest-400 rounded-t-2xl shadow-lg text-white text-2xl font-bold text-center">Ciclo de Vida de una Solicitud</div>
    <article class="mb-12 bg-forest-300">
        <div class="space-y-6">
                <!-- Open -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">üî¥ Abierto</div><p class="text-sm text-primary/90">La solicitud espera aprobaci√≥n inicial.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Acci√≥n Requerida:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Autorizar / Rechazar</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Supervisor, Manager</span></div></div>
                <!-- Authorized -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">üü£ Autorizado</div><p class="text-sm text-primary/90">Aprobada. Se deben adjuntar presupuestos.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Acci√≥n Requerida:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Adjuntar Presupuestos</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras, T√©cnico</span></div></div>
                <!-- Budgeted -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">üü¢ Presupuestado</div><p class="text-sm text-primary/90">Presupuestos adjuntados. Se requiere autorizaci√≥n de pago.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Acci√≥n Requerida:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Autorizar Pago / Rechazar</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Manager</span></div></div>
                 <!-- Rejected -->
                <div class="p-4 bg-yellow-50 border-yellow-300 rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">üü° Rechazado</div><p class="text-sm text-primary/90">Solicitud o presupuestos rechazados. Requiere revisi√≥n.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Acci√≥n Requerida:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Adjuntar Nuevos Presupuestos</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras, T√©cnico</span></div></div>
                <!-- Payment Authorized -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">üî∂ Pago Autorizado</div><p class="text-sm text-primary/90">Pago aprobado. Se inicia el proceso de facturaci√≥n.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Acci√≥n Requerida:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Procesar Pago</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras</span></div></div>
                <!-- Processing Payment -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">üí∞ Procesando Pago</div><p class="text-sm text-primary/90">Tr√°mites de pago en curso.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Acci√≥n Requerida:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Marcar como Enviado</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Gestor de Compras</span></div></div>
                <!-- Shipping -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">üì¶ En Env√≠o / Entrega</div><p class="text-sm text-primary/90">Producto o servicio pagado y en camino.</p><div class="flex flex-wrap items-center gap-2 mt-3"><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Acci√≥n Requerida:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Confirmar Recepci√≥n y Cerrar</span><span class="text-xs font-medium py-1 px-3 rounded-full border bg-surface text-text border-border">Responsable:</span> <span class="text-xs font-medium py-1 px-3 rounded-full border bg-primary/10 text-primary border-primary/20">Usuario, Gestor de Compras</span></div></div>
                <!-- Closed -->
                <div class="p-4 bg-white border border-border rounded-lg shadow-sm"><div class="font-semibold text-text mb-2 font-ui">‚ö´ Cerrado</div><p class="text-sm text-primary/90">Solicitud completada y finalizada.</p></div>
            </div>
    </article>

    <div class="w-fit mx-auto px-18 py-1 bg-forest-300 rounded-t-2xl shadow-lg text-white text-2xl font-bold text-center">Matriz de Transiciones por Rol</div>
    <article class="mb-12 bg-forest-200">
        <div class="overflow-x-auto bg-white p-4 rounded-lg border border-border">
                <table class="min-w-full text-sm text-left">
                    <thead class="bg-surface font-ui text-text"><tr><th class="p-2">Estado Origen</th><th class="p-2">Estado Destino</th><th class="p-2">Rol Responsable</th></tr></thead>
                    <tbody class="divide-y divide-border">
                        <tr class="hover:bg-surface/50"><td>Abierto</td><td>Autorizado</td><td>Supervisor, Manager</td></tr>
                        <tr class="hover:bg-surface/50"><td>Abierto</td><td>Cerrado (Cancelaci√≥n)</td><td>Supervisor, Manager, Usuario creador</td></tr>
                        <tr class="hover:bg-surface/50"><td>Autorizado</td><td>Presupuestado</td><td>Gestor de Compras, T√©cnico</td></tr>
                        <tr class="hover:bg-surface/50"><td>Presupuestado</td><td>Pago Autorizado</td><td>Manager</td></tr>
                        <tr class="hover:bg-surface/50"><td>Presupuestado</td><td>Rechazado</td><td>Supervisor, Manager</td></tr>
                        <tr class="hover:bg-surface/50"><td>Rechazado</td><td>Presupuestado</td><td>Gestor de Compras, T√©cnico</td></tr>
                        <tr class="hover:bg-surface/50"><td>Pago Autorizado</td><td>Procesando Pago</td><td>Gestor de Compras</td></tr>
                        <tr class="hover:bg-surface/50"><td>Procesando Pago</td><td>En Env√≠o / Entrega</td><td>Gestor de Compras</td></tr>
                        <tr class="hover:bg-surface/50"><td>En Env√≠o / Entrega</td><td>Cerrado</td><td>Usuario creador, Gestor de Compras</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4"><p class="text-sm text-blue-700 font-body"><strong class="font-semibold">Nota sobre Comentarios:</strong> A√±adir un comentario a una solicitud **no cambia su estado formal**. Los comentarios son para a√±adir informaci√≥n y dar seguimiento, pero la fase del ticket solo cambia con una acci√≥n de transici√≥n expl√≠cita.</p></div>
    </article>

    <div class="w-fit mx-auto px-18 py-1 bg-forest-200 rounded-t-2xl shadow-lg text-white text-2xl font-bold text-center">Caso Pr√°ctico: Adquisici√≥n de Licencias</div>
    <article class="mb-12 bg-forest-100 p-12">
        <ol class="relative border-l border-border ml-4">
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-user"></i></span><p class="text-sm text-primary/90 font-body"><strong>Usuario Final</strong> crea la solicitud "T√≥ner para HP1234 de Punto de Venta 4". Estado ‚Üí <strong>Abierto</strong>.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-user-tie"></i></span><p class="text-sm text-primary/90 font-body"><strong>Supervisor</strong> aprueba la solicitud. Estado ‚Üí <strong>Autorizado</strong>.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-file-invoice-dollar"></i></span><p class="text-sm text-primary/90 font-body"><strong>Gestor de Compras</strong> adjunta los presupuestos. Estado ‚Üí <strong>Presupuestado</strong>.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-crown"></i></span><p class="text-sm text-primary/90 font-body"><strong>Manager</strong> aprueba el pago del presupuesto seleccionado. Estado ‚Üí <strong>Pago Autorizado</strong>.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-credit-card"></i></span><p class="text-sm text-primary/90 font-body"><strong>Gestor de Compras</strong> realiza el pago. Estado ‚Üí <strong>Procesando Pago</strong>.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-shipping-fast"></i></span><p class="text-sm text-primary/90 font-body">Gestor actualiza el estado a <strong>En Env√≠o / Entrega</strong>.</p></li>
                <li class="mb-6 ml-6"><span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white"><i class="fa fa-check-circle"></i></span><p class="text-sm text-primary/90 font-body"><strong>Usuario Final</strong> confirma la recepci√≥n. Estado ‚Üí <strong>Cerrado</strong>.</p></li>
            </ol>
    </article>

</section>
{% endblock %}
{% block scripts %}
    {% vite_asset 'frontend/js/mermaid-init.js' %}
{% endblock %} 